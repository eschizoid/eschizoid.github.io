<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Supercharge SageMaker with Deep Lake capabilities - Mariano Gonzalez</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Supercharge SageMaker with Deep Lake capabilities">
<meta itemprop="description" content="Model Training with SageMaker and Deep Lake"><meta itemprop="datePublished" content="2023-04-30T14:21:17-05:00" />
<meta itemprop="dateModified" content="2023-04-30T14:21:17-05:00" />
<meta itemprop="wordCount" content="471">
<meta itemprop="keywords" content="sagemaker,langchain,deep lake,aws,databricks,activeloop," /><meta property="og:title" content="Supercharge SageMaker with Deep Lake capabilities" />
<meta property="og:description" content="Model Training with SageMaker and Deep Lake" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mariano-gonzalez.com/posts/post-3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-30T14:21:17-05:00" />
<meta property="article:modified_time" content="2023-04-30T14:21:17-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Supercharge SageMaker with Deep Lake capabilities"/>
<meta name="twitter:description" content="Model Training with SageMaker and Deep Lake"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://mariano-gonzalez.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://mariano-gonzalez.com/css/main.css" />
	<script defer type="text/javascript"  src="/js/copy-code.js"></script>

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://mariano-gonzalez.com/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://mariano-gonzalez.com/js/main.js"></script>

	
		<link rel="stylesheet" href="/css/copy-code-button.css">
	
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://mariano-gonzalez.com/">Mariano Gonzalez</a></h1>
	<div class="site-description"><p>Coder and Computer Enthusiast</p><nav class="nav social">
			<ul class="flat"><li><a href="https://www.linkedin.com/in/marianogonzalezmx/?locale=en_US" title="LinkedIn"><i data-feather="linkedin"></i></a></li><li><a href="https://github.com/eschizoid" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a href="#" class="scheme-toggle" id="scheme-toggle"></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">30</span>
							<span class="rest">Apr 2023</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Supercharge SageMaker with Deep Lake capabilities</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h2 id="introduction">Introduction</h2>
<h2 id="getting-started">Getting Started</h2>
<p>First, we will install everything we&rsquo;ll need.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!python3 - m pip install - -upgrade langchain deeplake sagemaker tiktoken</span></span></code></pre>
</figure><p>Next, let&rsquo;s import the necessary packages and make sure the Activeloop and OpenAI keys are in the environmental
variables ACTIVELOOP_TOKEN, OPENAI_API_KEY and define the OpenAI embeddings. For full documentation of Deep Lake please
the Deep Lake LangChain docs page and the Deep Lake API reference.</p>
<p>You&rsquo;d need to authenticate into Deep Lake if you want to create your own dataset and publish it. You can get an API key
from the Deep Lake platform here</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">os</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">getpass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.embeddings.sagameker</span> <span style="color:#ff7b72">import</span> SageMakerEmbeddings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#ff7b72;font-weight:bold">.</span>environ[<span style="color:#a5d6ff">&#39;ACTIVELOOP_TOKEN&#39;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> getpass<span style="color:#ff7b72;font-weight:bold">.</span>getpass(<span style="color:#a5d6ff">&#39;Activeloop Token:&#39;</span>)
</span></span><span style="display:flex;"><span>embeddings <span style="color:#ff7b72;font-weight:bold">=</span> SageMakerEmbeddings()</span></span></code></pre>
</figure><p>You can skip this part and jump right into using an already indexed dataset (just like the one in this example). To
index the code base, first clone the repository, parse the code, break it into chunks, and apply OpenAI indexing:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!git clone https://github.com/apache/spark</span></span></code></pre>
</figure><p>Next, load all files inside the repository. This will take a while, so feel free to grab a cup of coffee.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">os</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.document_loaders</span> <span style="color:#ff7b72">import</span> TextLoader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root_dir <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#39;spark&#39;</span>
</span></span><span style="display:flex;"><span>docs <span style="color:#ff7b72;font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> dirpath, dirnames, filenames <span style="color:#ff7b72;font-weight:bold">in</span> os<span style="color:#ff7b72;font-weight:bold">.</span>walk(root_dir):
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">for</span> file <span style="color:#ff7b72;font-weight:bold">in</span> filenames:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            loader <span style="color:#ff7b72;font-weight:bold">=</span> TextLoader(os<span style="color:#ff7b72;font-weight:bold">.</span>path<span style="color:#ff7b72;font-weight:bold">.</span>join(dirpath, file), encoding<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>            docs<span style="color:#ff7b72;font-weight:bold">.</span>extend(loader<span style="color:#ff7b72;font-weight:bold">.</span>load_and_split())
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">pass</span></span></span></code></pre>
</figure><p>Subsequently, divide the loaded files into chunks:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.text_splitter</span> <span style="color:#ff7b72">import</span> CharacterTextSplitter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>text_splitter <span style="color:#ff7b72;font-weight:bold">=</span> CharacterTextSplitter(chunk_size<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">1000</span>, chunk_overlap<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>texts <span style="color:#ff7b72;font-weight:bold">=</span> text_splitter<span style="color:#ff7b72;font-weight:bold">.</span>split_documents(docs)</span></span></code></pre>
</figure><p>Perform the indexing process. This takes roughly 4 minutes to calculate embeddings and upload them to Activeloop.
Afterward, you can publish the dataset publicly:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.vectorstores</span> <span style="color:#ff7b72">import</span> DeepLake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>username <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;eschizoid&#34;</span>
</span></span><span style="display:flex;"><span>db <span style="color:#ff7b72;font-weight:bold">=</span> DeepLake(dataset_path<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;hub://</span><span style="color:#a5d6ff">{</span>username<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/spark&#34;</span>, embedding_function<span style="color:#ff7b72;font-weight:bold">=</span>embeddings, public<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>)
</span></span><span style="display:flex;"><span>db<span style="color:#ff7b72;font-weight:bold">.</span>add_documents(texts)</span></span></code></pre>
</figure><p>First, we specify a path for storing the Deep Lake dataset containing the embeddings and their metadata.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span>username <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;eschizoid&#34;</span>
</span></span><span style="display:flex;"><span>dataset_path <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#39;hub://eschizoid/spark&#39;</span></span></span></code></pre>
</figure><p>Next, we specify an OpenAI algorithm for creating the embeddings, and create the VectorStore. This process creates an
embedding for each element in the texts lists and stores it in Deep Lake format at the specified path.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.embeddings.sagemaker_endpoint</span> <span style="color:#ff7b72">import</span> SagemakerEndpointEmbeddings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>embeddings <span style="color:#ff7b72;font-weight:bold">=</span> SagemakerEndpointEmbeddings()</span></span></code></pre>
</figure><figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.vectorstores</span> <span style="color:#ff7b72">import</span> DeepLake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#ff7b72;font-weight:bold">=</span> DeepLake<span style="color:#ff7b72;font-weight:bold">.</span>from_documents(texts, embeddings, dataset_path<span style="color:#ff7b72;font-weight:bold">=</span>dataset_path)</span></span></code></pre>
</figure><p>The Deep Lake dataset serving as a VectorStore has 4 tensors including the embedding, its ids, metadata including the
filename of the text, and the text itself.</p>
<table>
<thead>
<tr>
<th>tensor</th>
<th>htype</th>
<th>shape</th>
<th>dtype</th>
<th>compression</th>
</tr>
</thead>
<tbody>
<tr>
<td>embedding</td>
<td>generic</td>
<td>(23156, 1536)</td>
<td>float32</td>
<td>None</td>
</tr>
<tr>
<td>ids</td>
<td>text</td>
<td>(23156, 1)</td>
<td>str</td>
<td>None</td>
</tr>
<tr>
<td>metadata</td>
<td>json</td>
<td>(23156, 1)</td>
<td>str</td>
<td>None</td>
</tr>
<tr>
<td>text</td>
<td>text</td>
<td>(23156, 1)</td>
<td>str</td>
<td>None</td>
</tr>
</tbody>
</table>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#ff7b72;font-weight:bold">=</span> DeepLake(dataset_path<span style="color:#ff7b72;font-weight:bold">=</span>dataset_path, read_only<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>, embedding_function<span style="color:#ff7b72;font-weight:bold">=</span>embeddings)</span></span></code></pre>
</figure><figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>retriever <span style="color:#ff7b72;font-weight:bold">=</span> db<span style="color:#ff7b72;font-weight:bold">.</span>as_retriever()
</span></span><span style="display:flex;"><span>retriever<span style="color:#ff7b72;font-weight:bold">.</span>search_kwargs[<span style="color:#a5d6ff">&#39;distance_metric&#39;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#39;cos&#39;</span>
</span></span><span style="display:flex;"><span>retriever<span style="color:#ff7b72;font-weight:bold">.</span>search_kwargs[<span style="color:#a5d6ff">&#39;k&#39;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">20</span></span></span></code></pre>
</figure><figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain</span> <span style="color:#ff7b72">import</span> SagemakerEndpoint
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.llms.sagemaker_endpoint</span> <span style="color:#ff7b72">import</span> LLMContentHandler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">ContentHandler</span>(LLMContentHandler):
</span></span><span style="display:flex;"><span>    content_type <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>    accepts <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">transform_input</span>(self, prompt: str, model_kwargs) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>        input_str <span style="color:#ff7b72;font-weight:bold">=</span> json<span style="color:#ff7b72;font-weight:bold">.</span>dumps({prompt: prompt, <span style="color:#ff7b72;font-weight:bold">**</span>model_kwargs})
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> input_str<span style="color:#ff7b72;font-weight:bold">.</span>encode(<span style="color:#a5d6ff">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">transform_output</span>(self, output: bytes) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        response_json <span style="color:#ff7b72;font-weight:bold">=</span> json<span style="color:#ff7b72;font-weight:bold">.</span>loads(output<span style="color:#ff7b72;font-weight:bold">.</span>read()<span style="color:#ff7b72;font-weight:bold">.</span>decode(<span style="color:#a5d6ff">&#34;utf-8&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> response_json[<span style="color:#a5d6ff">0</span>][<span style="color:#a5d6ff">&#34;generated_text&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>se <span style="color:#ff7b72;font-weight:bold">=</span> SagemakerEndpoint(
</span></span><span style="display:flex;"><span>    endpoint_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;dolly-v2-12b&#34;</span>,
</span></span><span style="display:flex;"><span>    region_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;us-east-1&#34;</span>,
</span></span><span style="display:flex;"><span>    credentials_profile_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>    content_handler<span style="color:#ff7b72;font-weight:bold">=</span>ContentHandler(),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff7b72;font-weight:bold">=</span> ChatOpenAI(model<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#39;gpt-4&#39;</span>) <span style="color:#8b949e;font-style:italic"># &#39;gpt-3.5-turbo&#39;,</span>
</span></span><span style="display:flex;"><span>qa <span style="color:#ff7b72;font-weight:bold">=</span> RetrievalQA<span style="color:#ff7b72;font-weight:bold">.</span>from_llm(model, retriever<span style="color:#ff7b72;font-weight:bold">=</span>retriever)</span></span></code></pre>
</figure>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/sagemaker">sagemaker</a></li>
							
							<li><a href="/tags/langchain">langchain</a></li>
							
							<li><a href="/tags/deep-lake">deep lake</a></li>
							
							<li><a href="/tags/aws">aws</a></li>
							
							<li><a href="/tags/databricks">databricks</a></li>
							
							<li><a href="/tags/activeloop">activeloop</a></li>
							
						</ul>
					
				
			</div><l></l><div id="disqus_thread"></div>
<script>

    (function() {
        
        
        if (window.location.hostname == "localhost")
            return;

        var d = document, s = d.createElement('script');
        s.src = 'https://mariano-gonzalez.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2023  <p>Copyright © 2023 Mariano Gonzalez</p><p xmlns:dct='http://purl.org/dc/terms/' xmlns:cc='http://creativecommons.org/ns#' class='license-text'><a rel='cc:attributionURL' property='dct:title' href='https://github.com/eschizoid/eschizoid.github.io/tree/main/content'>Content</a> licensed under <a rel='license' href='https://creativecommons.org/licenses/by/4.0'>CC BY 4.0</a></p> |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-1R50XCY25D"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1R50XCY25D');
</script><script>feather.replace()</script>
</body>
</html>
