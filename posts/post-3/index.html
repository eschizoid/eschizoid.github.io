<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Supercharge SageMaker with Deep Lake capabilities - Mariano Gonzalez</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="Supercharge SageMaker with Deep Lake capabilities">
<meta itemprop="description" content="Integrate SageMaker with a vector database"><meta itemprop="datePublished" content="2023-05-13T15:50:53-05:00" />
<meta itemprop="dateModified" content="2023-05-13T15:50:53-05:00" />
<meta itemprop="wordCount" content="681">
<meta itemprop="keywords" content="sagemaker,langchain,deep lake,aws,databricks,activeloop," /><meta property="og:title" content="Supercharge SageMaker with Deep Lake capabilities" />
<meta property="og:description" content="Integrate SageMaker with a vector database" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mariano-gonzalez.com/posts/post-3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-13T15:50:53-05:00" />
<meta property="article:modified_time" content="2023-05-13T15:50:53-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Supercharge SageMaker with Deep Lake capabilities"/>
<meta name="twitter:description" content="Integrate SageMaker with a vector database"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://mariano-gonzalez.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://mariano-gonzalez.com/css/main.css" />
	<script defer type="text/javascript"  src="/js/copy-code.js"></script>

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://mariano-gonzalez.com/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://mariano-gonzalez.com/js/main.js"></script>

	
		<link rel="stylesheet" href="/css/copy-code-button.css">
	
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://mariano-gonzalez.com/">Mariano Gonzalez</a></h1>
	<div class="site-description"><p>Coder and Computer Enthusiast</p><nav class="nav social">
			<ul class="flat"><li><a href="https://www.linkedin.com/in/marianogonzalezmx/?locale=en_US" title="LinkedIn"><i data-feather="linkedin"></i></a></li><li><a href="https://github.com/eschizoid" title="Github"><i data-feather="github"></i></a></li><li><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a href="#" class="scheme-toggle" id="scheme-toggle"></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">13</span>
							<span class="rest">May 2023</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Supercharge SageMaker with Deep Lake capabilities</h1>
				</div>
			</div>
					
			<div class="markdown">
				<h2 id="introduction">Introduction</h2>
<p>Deep Lake serves as a vector database that can integrate with Amazon SageMaker, allowing the storage of &ldquo;embeddings&rdquo;
which are vector representations of data used in deep learning models. By leveraging Deep Lake&rsquo;s vector database
capabilities, developers can accelerate the training and deployment of their deep learning models. In this blog post, we
will explore the details of this integration and how the use of vector databases can enhance the performance and
accuracy of deep learning models.</p>
<h2 id="getting-started">Getting Started</h2>
<h3 id="step-1-installing-required-libraries-and-authenticating-with-deep-lake-and-sagemaker">Step 1: Installing required libraries and authenticating with Deep Lake and SageMaker</h3>
<p>First, we will install everything we&rsquo;ll need.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!python3 - m pip install --upgrade langchain deeplake sagemaker tiktoken boto3</span></span></code></pre>
</figure><p>Next, let&rsquo;s import the necessary packages and make sure the Activeloop key is in the environmental
variable <code>ACTIVELOOP_TOKEN</code> and define the SageMaker embeddings. For more documentation please refer to the links below:</p>
<ul>
<li><a href="https://docs.activeloop.ai/tutorials/deep-lake-vector-store-in-langchain">Deep Lake and LangChain Integration</a></li>
<li><a href="https://docs.deeplake.ai/en/latest">Deep Lake API reference</a></li>
</ul>
<p>You&rsquo;d need to authenticate into Deep Lake and AWS. You can get an API key from the Deep Lake
platform <a href="https://app.activeloop.ai/">here</a></p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!aws configure set aws_access_key_id <span style="color:#ff7b72;font-weight:bold">[</span>REDACTED<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>!aws configure set aws_secret_access_key <span style="color:#ff7b72;font-weight:bold">[</span>REDACTED<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>!aws configure set default.region us-east-1
</span></span><span style="display:flex;"><span>!activeloop login -t <span style="color:#ff7b72;font-weight:bold">[</span>REDACTED<span style="color:#ff7b72;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>!export <span style="color:#79c0ff">ACTIVELOOP_USERNAME</span><span style="color:#ff7b72;font-weight:bold">=[</span>REDACTED<span style="color:#ff7b72;font-weight:bold">]</span></span></span></code></pre>
</figure><p>Now you can proceed to deploy the SageMaker endpoint as usual:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">sagemaker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sess <span style="color:#ff7b72;font-weight:bold">=</span> sagemaker<span style="color:#ff7b72;font-weight:bold">.</span>Session()
</span></span><span style="display:flex;"><span>sagemaker_session_bucket <span style="color:#ff7b72;font-weight:bold">=</span> sess<span style="color:#ff7b72;font-weight:bold">.</span>default_bucket()
</span></span><span style="display:flex;"><span>role <span style="color:#ff7b72;font-weight:bold">=</span> sagemaker<span style="color:#ff7b72;font-weight:bold">.</span>get_execution_role()
</span></span><span style="display:flex;"><span>model_name <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;all-MiniLM-L6-v2&#34;</span>  <span style="color:#8b949e;font-style:italic"># &#34;mpt-7b-instruct&#34; # &#34;dolly-v2-12b&#34; &#34;flan-t5-xxl&#34;</span></span></span></code></pre>
</figure><figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">sagemaker.huggingface.model</span> <span style="color:#ff7b72">import</span> HuggingFaceModel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>huggingface_model <span style="color:#ff7b72;font-weight:bold">=</span> HuggingFaceModel(
</span></span><span style="display:flex;"><span>    model_data<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;s3://</span><span style="color:#a5d6ff">{</span>sess<span style="color:#ff7b72;font-weight:bold">.</span>default_bucket()<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/</span><span style="color:#a5d6ff">{</span>model_name<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/model.tar.gz&#34;</span>,
</span></span><span style="display:flex;"><span>    role<span style="color:#ff7b72;font-weight:bold">=</span>role,
</span></span><span style="display:flex;"><span>    transformers_version<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;4.26&#34;</span>,
</span></span><span style="display:flex;"><span>    pytorch_version<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;1.13&#34;</span>,
</span></span><span style="display:flex;"><span>    py_version<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;py39&#34;</span>,
</span></span><span style="display:flex;"><span>    model_server_workers<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre>
</figure><figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span>predictor <span style="color:#ff7b72;font-weight:bold">=</span> huggingface_model<span style="color:#ff7b72;font-weight:bold">.</span>deploy(
</span></span><span style="display:flex;"><span>    initial_instance_count<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">1</span>,
</span></span><span style="display:flex;"><span>    instance_type<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;ml.g5.8xlarge&#34;</span>,  <span style="color:#8b949e;font-style:italic"># &#34;ml.g5.4xlarge&#34;</span>
</span></span><span style="display:flex;"><span>    endpoint_name<span style="color:#ff7b72;font-weight:bold">=</span>model_name,
</span></span><span style="display:flex;"><span>    model_data_download_timeout<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">3600</span>,
</span></span><span style="display:flex;"><span>    container_startup_health_check_timeout<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">3600</span>,
</span></span><span style="display:flex;"><span>    update_endpoint<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>
</span></span><span style="display:flex;"><span>)</span></span></code></pre>
</figure><p>After the endpoint is deployed, you can use the following code to create a SageMaker endpoint embeddings object:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">json</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">typing</span> <span style="color:#ff7b72">import</span> Dict, List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.embeddings</span> <span style="color:#ff7b72">import</span> SagemakerEndpointEmbeddings
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.embeddings.sagemaker_endpoint</span> <span style="color:#ff7b72">import</span> EmbeddingsContentHandler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">ContentHandler</span>(EmbeddingsContentHandler):
</span></span><span style="display:flex;"><span>    content_type <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>    accepts <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">transform_input</span>(self, inputs: list[str], model_kwargs: Dict) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>        input_str <span style="color:#ff7b72;font-weight:bold">=</span> json<span style="color:#ff7b72;font-weight:bold">.</span>dumps({<span style="color:#a5d6ff">&#34;inputs&#34;</span>: inputs, <span style="color:#ff7b72;font-weight:bold">**</span>model_kwargs})
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> input_str<span style="color:#ff7b72;font-weight:bold">.</span>encode(<span style="color:#a5d6ff">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">transform_output</span>(self, output: bytes) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> List[List[float]]:
</span></span><span style="display:flex;"><span>        response_json <span style="color:#ff7b72;font-weight:bold">=</span> json<span style="color:#ff7b72;font-weight:bold">.</span>loads(output<span style="color:#ff7b72;font-weight:bold">.</span>read()<span style="color:#ff7b72;font-weight:bold">.</span>decode(<span style="color:#a5d6ff">&#34;utf-8&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> response_json[<span style="color:#a5d6ff">&#34;vectors&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>embeddings <span style="color:#ff7b72;font-weight:bold">=</span> SagemakerEndpointEmbeddings(
</span></span><span style="display:flex;"><span>    endpoint_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;all-MiniLM-L6-v2&#34;</span>,
</span></span><span style="display:flex;"><span>    region_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;us-east-1&#34;</span>,
</span></span><span style="display:flex;"><span>    content_handler<span style="color:#ff7b72;font-weight:bold">=</span>ContentHandler()
</span></span><span style="display:flex;"><span>)</span></span></code></pre>
</figure><h3 id="step-2-indexing-apache-sparkhttpsgithubcomapachespark-code-base">Step 2: Indexing Apache <a href="https://github.com/apache/spark">Spark</a> Code Base</h3>
<p>To index the code base, first clone the repository, parse the code, break it into chunks, and apply indexing:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>!git clone --depth <span style="color:#a5d6ff">1</span> https://github.com/apache/spark</span></span></code></pre>
</figure><p>Next, load all files inside the repository:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">os</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.document_loaders</span> <span style="color:#ff7b72">import</span> TextLoader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root_dir <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;spark&#34;</span>
</span></span><span style="display:flex;"><span>docs <span style="color:#ff7b72;font-weight:bold">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">for</span> dirpath, dirnames, filenames <span style="color:#ff7b72;font-weight:bold">in</span> os<span style="color:#ff7b72;font-weight:bold">.</span>walk(root_dir):
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">for</span> file <span style="color:#ff7b72;font-weight:bold">in</span> filenames:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">try</span>:
</span></span><span style="display:flex;"><span>            loader <span style="color:#ff7b72;font-weight:bold">=</span> TextLoader(os<span style="color:#ff7b72;font-weight:bold">.</span>path<span style="color:#ff7b72;font-weight:bold">.</span>join(dirpath, file), encoding<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>            docs<span style="color:#ff7b72;font-weight:bold">.</span>extend(loader<span style="color:#ff7b72;font-weight:bold">.</span>load_and_split())
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">except</span> <span style="color:#f0883e;font-weight:bold">Exception</span> <span style="color:#ff7b72">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#ff7b72">pass</span></span></span></code></pre>
</figure><p>Subsequently, divide the loaded files into chunks:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.text_splitter</span> <span style="color:#ff7b72">import</span> CharacterTextSplitter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>text_splitter <span style="color:#ff7b72;font-weight:bold">=</span> CharacterTextSplitter(chunk_size<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">1000</span>, chunk_overlap<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>texts <span style="color:#ff7b72;font-weight:bold">=</span> text_splitter<span style="color:#ff7b72;font-weight:bold">.</span>split_documents(docs)</span></span></code></pre>
</figure><p>Performing the indexing process roughly takes 4 minutes to calculate embeddings and upload them to Activeloop.
Afterward, you can publish the dataset publicly:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">os</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.vectorstores</span> <span style="color:#ff7b72">import</span> DeepLake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>username <span style="color:#ff7b72;font-weight:bold">=</span> os<span style="color:#ff7b72;font-weight:bold">.</span>getenv(<span style="color:#a5d6ff">&#34;[ACTIVELOOP_USERNAME]&#34;</span>)
</span></span><span style="display:flex;"><span>dataset_path <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;hub://</span><span style="color:#a5d6ff">{</span>username<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/spark&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#ff7b72;font-weight:bold">=</span> DeepLake(dataset_path<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;hub://</span><span style="color:#a5d6ff">{</span>username<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/spark&#34;</span>, embedding_function<span style="color:#ff7b72;font-weight:bold">=</span>embeddings, public<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>)
</span></span><span style="display:flex;"><span>db<span style="color:#ff7b72;font-weight:bold">.</span>add_documents(texts)</span></span></code></pre>
</figure><p>If the dataset has been already created, you can load it later without recomputing embeddings as seen below.</p>
<h3 id="step-3-conversational-retriever-chain">Step 3: Conversational Retriever Chain</h3>
<p>First, load the dataset, establish the retriever, and create the Conversational Chain:</p>
<p>A preview of the dataset would look something like this:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Dataset(path<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">f</span><span style="color:#a5d6ff">&#34;hub://</span><span style="color:#a5d6ff">{</span>username<span style="color:#a5d6ff">}</span><span style="color:#a5d6ff">/spark&#34;</span>, read_only<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>, tensors<span style="color:#ff7b72;font-weight:bold">=</span>[<span style="color:#a5d6ff">&#34;embedding&#34;</span>, <span style="color:#a5d6ff">&#34;ids&#34;</span>, <span style="color:#a5d6ff">&#34;metadata&#34;</span>, <span style="color:#a5d6ff">&#34;text&#34;</span>])</span></span></code></pre>
</figure><p>The Deep Lake dataset serving as a VectorStore has 4 tensors including the embedding, its ids, metadata including the
filename of the text, and the text itself.</p>
<table>
<thead>
<tr>
<th>tensor</th>
<th>htype</th>
<th>shape</th>
<th>dtype</th>
<th>compression</th>
</tr>
</thead>
<tbody>
<tr>
<td>embedding</td>
<td>generic</td>
<td>(23156, 1536)</td>
<td>float32</td>
<td>None</td>
</tr>
<tr>
<td>ids</td>
<td>text</td>
<td>(23156, 1)</td>
<td>str</td>
<td>None</td>
</tr>
<tr>
<td>metadata</td>
<td>json</td>
<td>(23156, 1)</td>
<td>str</td>
<td>None</td>
</tr>
<tr>
<td>text</td>
<td>text</td>
<td>(23156, 1)</td>
<td>str</td>
<td>None</td>
</tr>
</tbody>
</table>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.vectorstores</span> <span style="color:#ff7b72">import</span> DeepLake
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>db <span style="color:#ff7b72;font-weight:bold">=</span> DeepLake(dataset_path<span style="color:#ff7b72;font-weight:bold">=</span>dataset_path, read_only<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#79c0ff">True</span>, embedding_function<span style="color:#ff7b72;font-weight:bold">=</span>embeddings)</span></span></code></pre>
</figure><figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>retriever <span style="color:#ff7b72;font-weight:bold">=</span> db<span style="color:#ff7b72;font-weight:bold">.</span>as_retriever()
</span></span><span style="display:flex;"><span>retriever<span style="color:#ff7b72;font-weight:bold">.</span>search_kwargs[<span style="color:#a5d6ff">&#34;distance_metric&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;cos&#34;</span>
</span></span><span style="display:flex;"><span>retriever<span style="color:#ff7b72;font-weight:bold">.</span>search_kwargs[<span style="color:#a5d6ff">&#34;fetch_k&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">100</span>
</span></span><span style="display:flex;"><span>retriever<span style="color:#ff7b72;font-weight:bold">.</span>search_kwargs[<span style="color:#a5d6ff">&#34;maximal_marginal_relevance&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#79c0ff">True</span>
</span></span><span style="display:flex;"><span>retriever<span style="color:#ff7b72;font-weight:bold">.</span>search_kwargs[<span style="color:#a5d6ff">&#34;k&#34;</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">10</span></span></span></code></pre>
</figure><p>You can also define custom filtering functions using Deep Lake filters:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">filter</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> <span style="color:#a5d6ff">&#34;com.google&#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> x[<span style="color:#a5d6ff">&#34;text&#34;</span>]<span style="color:#ff7b72;font-weight:bold">.</span>data()[<span style="color:#a5d6ff">&#34;value&#34;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> <span style="color:#79c0ff">False</span>
</span></span><span style="display:flex;"><span>    metadata <span style="color:#ff7b72;font-weight:bold">=</span> x[<span style="color:#a5d6ff">&#34;metadata&#34;</span>]<span style="color:#ff7b72;font-weight:bold">.</span>data()[<span style="color:#a5d6ff">&#34;value&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">&#34;scala&#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> metadata[<span style="color:#a5d6ff">&#34;source&#34;</span>] <span style="color:#ff7b72;font-weight:bold">or</span> <span style="color:#a5d6ff">&#34;py&#34;</span> <span style="color:#ff7b72;font-weight:bold">in</span> metadata[<span style="color:#a5d6ff">&#34;source&#34;</span>]</span></span></code></pre>
</figure><p>Connect to the <code>LLM</code> for question answering.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff7b72">import</span> <span style="color:#ff7b72">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain</span> <span style="color:#ff7b72">import</span> SagemakerEndpoint
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.chains</span> <span style="color:#ff7b72">import</span> RetrievalQA
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">from</span> <span style="color:#ff7b72">langchain.llms.sagemaker_endpoint</span> <span style="color:#ff7b72">import</span> LLMContentHandler
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">ContentHandler</span>(LLMContentHandler):
</span></span><span style="display:flex;"><span>    content_type <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>    accepts <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">transform_input</span>(self, prompt: str, model_kwargs) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> bytes:
</span></span><span style="display:flex;"><span>        input_str <span style="color:#ff7b72;font-weight:bold">=</span> json<span style="color:#ff7b72;font-weight:bold">.</span>dumps({prompt: prompt, <span style="color:#ff7b72;font-weight:bold">**</span>model_kwargs})
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> input_str<span style="color:#ff7b72;font-weight:bold">.</span>encode(<span style="color:#a5d6ff">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">def</span> <span style="color:#d2a8ff;font-weight:bold">transform_output</span>(self, output: bytes) <span style="color:#ff7b72;font-weight:bold">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        response_json <span style="color:#ff7b72;font-weight:bold">=</span> json<span style="color:#ff7b72;font-weight:bold">.</span>loads(output<span style="color:#ff7b72;font-weight:bold">.</span>read()<span style="color:#ff7b72;font-weight:bold">.</span>decode(<span style="color:#a5d6ff">&#34;utf-8&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">return</span> response_json[<span style="color:#a5d6ff">0</span>][<span style="color:#a5d6ff">&#34;generated_text&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#ff7b72;font-weight:bold">=</span> SagemakerEndpoint(
</span></span><span style="display:flex;"><span>    endpoint_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;all-MiniLM-L6-v2&#34;</span>,
</span></span><span style="display:flex;"><span>    region_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;us-east-1&#34;</span>,
</span></span><span style="display:flex;"><span>    credentials_profile_name<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;default&#34;</span>,
</span></span><span style="display:flex;"><span>    content_handler<span style="color:#ff7b72;font-weight:bold">=</span>ContentHandler(),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>qa <span style="color:#ff7b72;font-weight:bold">=</span> RetrievalQA<span style="color:#ff7b72;font-weight:bold">.</span>from_llm(model, retriever<span style="color:#ff7b72;font-weight:bold">=</span>retriever)</span></span></code></pre>
</figure>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/sagemaker">sagemaker</a></li>
							
							<li><a href="/tags/langchain">langchain</a></li>
							
							<li><a href="/tags/deep-lake">deep lake</a></li>
							
							<li><a href="/tags/aws">aws</a></li>
							
							<li><a href="/tags/databricks">databricks</a></li>
							
							<li><a href="/tags/activeloop">activeloop</a></li>
							
						</ul>
					
				
			</div><l></l><div id="disqus_thread"></div>
<script>

    (function() {
        
        
        if (window.location.hostname == "localhost")
            return;

        var d = document, s = d.createElement('script');
        s.src = 'https://mariano-gonzalez.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2023  <p>Copyright Â© 2023 Mariano Gonzalez</p><p xmlns:dct='http://purl.org/dc/terms/' xmlns:cc='http://creativecommons.org/ns#' class='license-text'><a rel='cc:attributionURL' property='dct:title' href='https://github.com/eschizoid/eschizoid.github.io/tree/main/content'>Content</a> licensed under <a rel='license' href='https://creativecommons.org/licenses/by/4.0'>CC BY 4.0</a></p> |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-1R50XCY25D"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1R50XCY25D');
</script><script>feather.replace()</script>
</body>
</html>
